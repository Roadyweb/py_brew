{% extends "layout.html" %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" media="all" type="text/css" href="{{ url_for('static', filename='plugins/jquery/jquery-ui.css') }}" />
    <link rel="stylesheet" media="all" type="text/css" href="{{ url_for('static', filename='plugins/timepicker/jquery-ui-timepicker-addon.css') }}" />

    <script type="text/javascript" src="{{ url_for('static', filename='plugins/jquery/jquery-ui.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='plugins/timepicker/jquery-ui-timepicker-addon.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='plugins/timepicker/i18n/jquery-ui-timepicker-addon-i18n.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='plugins/timepicker/jquery-ui-sliderAccess.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/api_buttons.js') }}"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        socket.on('connect', function() {
            socket.emit('my event', {data: 'Client: I\'m connected!'});
            console.log('Client: I\'m connected!');
        });
        socket.on('message', function(data) {
            socket.emit('my event', {data: 'Client: Received a message'});
            console.log('message ' + String(data));
        });
        socket.on('data', function(data) {
            // socket.emit('my event', {data: 'Client: Received a data message'});
            // console.log('data ' + typeof(data) + data);
            var jdata = $.parseJSON(data);
            console.log('jdata ' + typeof(jdata) + data);
            $( "#val_ztk1" ).text(jdata.settempk1.toFixed(1) + ' °C');
            $( "#val_ztk2" ).text(jdata.settempk2.toFixed(1) + ' °C');
            $( "#val_tk1" ).text(jdata.tempk1.toFixed(1) + ' °C');
            $( "#val_tk2" ).text(jdata.tempk2.toFixed(1) + ' °C');
            $( "#val_korr_tk1" ).text(jdata.tempk1_offset.toFixed(1) + ' °C');
            $( "#val_heater" ).text(jdata.heater);
            $( "#val_pump1" ).text(jdata.pump1);
            $( "#val_pump2" ).text(jdata.pump2);
            $( "#val_dura_k1" ).text(jdata.setdurak1 + ' s');
            $( "#val_dura_k2" ).text(jdata.setdurak2 + ' s');
            $( "#val_pct_state" ).text(jdata.pct_state + ' ' + jdata.pct_state_min_to_wait);
            $( "#val_simulation" ).text(jdata.simulation);
            $( "#val_tmt_state" ).text(jdata.tmt_state);
            $( "#val_wqt_state" ).text(jdata.wqt_state);
            $( "#val_dlt_state" ).text(jdata.dlt_state);
            $( "#val_bm_state" ).text(jdata.bm_state);
            $( "#val_cook_state" ).text(jdata.cook_state + ' Stufe ' + jdata.cook_state_stage + ' - ' + jdata.cook_state_extended);

            // Some local variables
            var running = false;
            var running_k2 = false;
            if (jdata.pct_state == 'Waiting' || jdata.pct_state == 'Running') { running = true };
            if (jdata.recipe != null && jdata.recipe.method == 'K2' && running) { running_k2 = true };
            // console.log('Running: ' + String(running))
            // console.log('Running K2: ' + String(running_k2))

            // Adjust background color for Temp K1
            if (running && jdata.tempk1 < (jdata.settempk1 - jdata.hyst)) {
              console.log('K1 cool');
              $( "#val_tk1" ).attr('class', 'table-bg-blue')
            } else if (running && jdata.tempk1 > (jdata.settempk1 + jdata.hyst)) {
              console.log('K1 hot');
              $( "#val_tk1" ).attr('class', 'table-bg-red')
            } else if (running && (jdata.tempk1 > (jdata.settempk1 - jdata.hyst)) && (jdata.tempk1 < (jdata.settempk1 + jdata.hyst))) {
              console.log('K1 right');
              $( "#val_tk1" ).attr('class', 'table-bg-green')
            } else {
              $( "#val_tk1" ).attr('class', '')
            }

            // Adjust background color for Temp K2
            if (running && jdata.tempk2 < (jdata.settempk2 - jdata.hyst)) {
              console.log('K2 cool');
              $( "#val_tk2" ).attr('class', 'table-bg-blue')
            } else if (running && jdata.tempk2 > (jdata.settempk2 + jdata.hyst)) {
              console.log('K2 hot');
              $( "#val_tk2" ).attr('class', 'table-bg-red')
            } else if (running && (jdata.tempk2 > (jdata.settempk2 - jdata.hyst)) && (jdata.tempk2 < (jdata.settempk2 + jdata.hyst))) {
              console.log('K2 right');
              $( "#val_tk2" ).attr('class', 'table-bg-green')
            } else {
              $( "#val_tk2" ).attr('class', '')
            }

        });
        socket.on('disconnect', function() {
            socket.emit('my event', {data: 'Client: I\'m disconnected!'});
            console.log('Client: I\'m disconnected!');
        });
    </script>
{% endblock %}

{% block body %}
  <!-- some local variables for jinja-->
  {% set running = state.pct_state == "Waiting" or state.pct_state == "Running" %}
  {% set running_k2 = data.method == 'K2' and running %}
  <div class="row">
    <div class="col-md-6">
      <table class="table">
        <thead>
          <tr>
            <th colspan="4">Rezept</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Name</td><td>{{ data.name }}</td>
          </tr>
          <tr>
            <td>Erstellt</td><td>{{ data.created }}</td>
          </tr>
          <tr>
            <td>Letzte Änderung</td><td>{{ data.last_saved }}</td>
          </tr>
        </tbody>
      </table>
      <table class="table">
        <thead>
          <tr>
            <th colspan="4">Einstellungen</th>
          </tr>
        </thead>
        <tbody>
          <tr
            {% if data.method == 'K1' and state.cook_state == 'Init' and state.cook_state_stage == 1 %}class=table-bg-red{% endif %}
            {% if data.method == 'K1' and state.cook_state == 'Cooking' and state.cook_state_stage == 1 %}class=table-bg-green{% endif %}
          >
            <td>Kochtemp. K1</td><td>{{ data.tempk1 }} °C</td>
            <td>Kochdauer K1</td><td>{{ data.durak1 }} s</td>
          </tr>
          {% if data.method == 'K2' %}
          {% for entry in data.list %}
            <tr
              {% if data.method == 'K2' and state.cook_state == 'Init' and state.cook_state_stage == loop.index %}class=table-bg-red{% endif %}
              {% if data.method == 'K2' and state.cook_state == 'Cooking' and state.cook_state_stage == loop.index %}class=table-bg-green{% endif %}
            >
              <td>Rasttemp. K2</td><td>{{ entry[0]|safe }} °C</td>
              <td>Rastdauer K2</td><td>{{ entry[1]|safe }} s</td>
            </tr>
          {% else %}
            <em>No entries</em>
          {% endfor %}
          {% endif %}
          <tr>
            <td>Methode</td>
            <td>{{ data.method }}</td>
            <td>Hysterese</td>
            <td>+/- {{'%0.1f' % state.hyst }} K</td>
          </tr>
        </tbody>
      </table>
      <table class="table">
        <tbody>
        </tbody>
      </table>
      <form action="." method="POST">
        <input type="submit" name="btn_start_at" class="btn btn-default" value="Starte um" {% if running %}disabled{% endif %}>
        <input type="text" name="start_time" id="basic_example_2" value="{{ start_at }}" />
        <script type="text/javascript">
          $('#basic_example_2').timepicker();
        </script>
        <br/><br/>
        <input type="submit" name="btn_start" class="btn btn-default" value="Start" {% if running %}disabled{% endif %}>
        <input type="submit" name="btn_stop" class="btn btn-default" value="Stop">
        <input type="submit" name="btn_t1_up" class="btn btn-default" value="K1 + 0.2 K">
        <input type="submit" name="btn_t1_down" class="btn btn-default" value="K1 - 0.2 K">
      </form>
    </div>
    <div class="col-md-6">
      <table class="table">
        <thead>
          <tr>
            <th colspan="4">Status</th>
          </tr>
        </thead>
        {% if state %}
        <tbody>
          <tr>
            <td>Zieltemp K1</td><td id="val_ztk1">{{'%0.1f' % state.settempk1 }} °C</td>
            <td>Zieltemp K2</td><td id="val_ztk2">{{'%0.1f' % state.settempk2 }} °C</td>
          </tr>
          <tr>
            <td>Temp K1</td>
            <td id="val_tk1"
              {% if running and state.tempk1 < ( state.settempk1 - state.hyst) %}class=table-bg-blue {% endif %}
              {% if running and state.tempk1 > ( state.settempk1 + state.hyst) %}class=table-bg-red {% endif %}
              {% if running and (state.tempk1 > ( state.settempk1 - state.hyst) and state.tempk1 < ( state.settempk1 + state.hyst)) %}class=table-bg-green {% endif %}
            >{{'%0.1f' % state.tempk1 }} °C </td>
            <td>Temp K2</td>
            <td id="val_tk2"
              {% if running_k2 and state.tempk2 < ( state.settempk2 - state.hyst) %}class=table-bg-blue {% endif %}
              {% if running_k2 and state.tempk2 > ( state.settempk2 + state.hyst) %}class=table-bg-red {% endif %}
              {% if running_k2 and (state.tempk2 > ( state.settempk2 - state.hyst) and state.tempk2 < ( state.settempk2 + state.hyst)) %}class=table-bg-green {% endif %}
            >{{'%0.1f' % state.tempk2 }} °C</td>
          </tr>
          <tr>
            <td>Korrektur Temp K1</td><td id="val_korr_tk1">{{'%0.1f' % state.tempk1_offset }} °C</td>
            <td>Heizung</td><td id="val_heater">{{ state.heater }}</td>
          </tr>
          <tr>
            <td>Pumpe 1</td><td id="val_pump1">{{ state.pump1 }}</td>
            <td>Pumpe 2</td><td id="val_pump2">{{ state.pump2 }}</td>
          </tr>
        </tbody>
      {% else %}
        <p>No current data available</p>
      {% endif %}
      </table>
      <table class="table">
        <thead>
          <tr>
            <th colspan="4">Debug</th>
          </tr>
        </thead>
        {% if state %}
        <tbody>
          <tr>
            <td>Dauer K1</td><td id="val_dura_k1">{{'%d' % state.setdurak1 }} s</td>
            <td>Dauer K2</td><td id="val_dura_k2">{{'%d' % state.setdurak2 }} s</td>
          </tr>
          <tr>
            <td>ProcControl</td><td id="val_pct_state">{{ state.pct_state }} {{ state.pct_state_min_to_wait }}</td>
            <td>Simulation</td><td id="val_simulation">{{ state.simulation }}</td>
          </tr>
          <tr>
            <td>TempMon</td><td id="val_tmt_state">{{ state.tmt_state }}</td>
            <td>WorkQueue</td><td id="val_wqt_state">{{ state.wqt_state }}</td>
          </tr>
          <tr>
            <td>DataLogger</td><td id="val_dlt_state">{{ state.dlt_state }}</td>
            <td>BlubberManager</td><td id="val_bm_state">{{ state.bm_state }}</td>
          </tr>
          <tr>
            <td>Cook State</td>
            <td colspan="3"  id="val_cook_state">{{ state.cook_state }} Stufe {{ state.cook_state_stage }} - {{ state.cook_state_extended }}</td>
          </tr>
        </tbody>
      {% else %}
        <p>No current data available</p>
      {% endif %}
      </table>
    </div>
  </div>
  {% with messages = get_flashed_messages() %}
    {% if messages %}
        <ul class=flashes>
        {% for message in messages %}
            <li>{{ message }}</li>
        {% endfor %}
        </ul>
    {% endif %}
  {% endwith %}
{% endblock %}
